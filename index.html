<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì§€ì˜ì´ì˜ ì˜ì–´ ê³µë¶€</title>
    <style>
        :root { --primary: #ff4757; --secondary: #007aff; --bg: #fff9f9; }
        body { font-family: 'Apple SD Gothic Neo', sans-serif; text-align: center; padding: 0; margin: 0; background-color: var(--bg); color: #333; }
        .nav-tabs { display: flex; background: white; border-bottom: 1px solid #eee; position: sticky; top: 0; z-index: 100; }
        .tab { flex: 1; padding: 15px; font-size: 18px; font-weight: bold; cursor: pointer; color: #888; }
        .tab.active { color: var(--primary); border-bottom: 3px solid var(--primary); }
        .container { max-width: 500px; margin: 20px auto; padding: 0 20px; box-sizing: border-box; }
        .page { display: none; }
        .page.active { display: block; }
        .situation-tag { background: #ffeaa7; color: #d63031; padding: 5px 15px; border-radius: 50px; font-weight: bold; font-size: 14px; margin-bottom: 15px; display: inline-block; }
        .card { background: white; padding: 35px 20px; border-radius: 25px; box-shadow: 0 8px 15px rgba(0,0,0,0.05); border: 2px solid #ffccd5; margin-bottom: 15px; position: relative; min-height: 180px; display: flex; flex-direction: column; justify-content: center; }
        .card::before { content: attr(data-speaker); position: absolute; top: -15px; left: 20px; background: #555; color: white; padding: 4px 15px; border-radius: 10px; font-size: 14px; font-weight: bold; }
        .card.user-card { border-color: var(--secondary); background: #f0f7ff; }
        .card.user-card::before { background: var(--secondary); }
        .meaning { font-size: 22px; color: #444; font-weight: bold; margin-bottom: 10px; }
        .english { font-size: 26px; font-weight: bold; color: var(--secondary); margin: 10px 0; line-height: 1.3; }
        .pronunciation { font-size: 18px; color: #888; margin-bottom: 15px; }
        .btn-group { display: flex; gap: 10px; margin: 20px 0; }
        .nav-btn { flex: 1; padding: 18px; border-radius: 15px; border: none; background: var(--primary); color: white; cursor: pointer; font-size: 18px; font-weight: bold; box-shadow: 0 5px 0 #e03a49; }
        .nav-btn.prev { background: #bbb; box-shadow: 0 5px 0 #999; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; }
        .spinner { border: 5px solid #f3f3f3; border-top: 5px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <div class="spinner"></div>
        <div id="loading-text" style="font-weight: bold; color: #555;">ì§€ì˜ ë‹˜ì˜ ëŒ€ë³¸ì„ ìƒì„±í•˜ê³  ìˆì–´ìš”...</div>
    </div>

    <div class="nav-tabs">
        <div class="tab active" id="tab-study" onclick="switchPage('study')">ğŸ“– ëŒ€í™” ì—°ìŠµ</div>
        <div class="tab" id="tab-stats" onclick="switchPage('stats')">ğŸ“Š ê³µë¶€ ê¸°ë¡</div>
    </div>
    
    <div class="container">
        <div id="study-page" class="page active">
            <div id="content-area">
                <div class="situation-tag" id="lbl-situation">ğŸ“ ì¤€ë¹„ ì¤‘...</div>
                <div class="card" id="speaker-card" data-speaker="ëŒ€ê¸°">
                    <p class="meaning" id="lbl-meaning"></p>
                    <p class="english" id="lbl-english"></p>
                    <p class="pronunciation" id="lbl-pronunciation"></p>
                    <button onclick="playCurrentTTS()" style="background:#e1f5fe; color:#0288d1; border:none; padding:10px 20px; border-radius:50px; cursor:pointer; font-weight:bold; align-self:center;">ğŸ”Š ì†Œë¦¬ ë“£ê¸°</button>
                </div>
                <div class="btn-group" id="main-btns">
                    <button class="nav-btn prev" id="btn-prev" onclick="prevStep()">â¬…ï¸ ì´ì „</button>
                    <button class="nav-btn" id="btn-next" onclick="nextStep()">ë‹¤ìŒ â¡ï¸</button>
                </div>
                <button class="nav-btn" id="btn-restart" style="display:none; background:#555; box-shadow:0 5px 0 #333;" onclick="location.reload()">ìƒˆë¡œìš´ ìƒí™© ì‹œì‘</button>
            </div>
        </div>
        
        <div id="stats-page" class="page">
            <div id="stat-info" style="display:flex; gap:10px; margin-bottom:20px;">
                <div style="flex:1; background:white; padding:15px; border-radius:15px;">íšŸìˆ˜: <b id="stat-total" style="color:var(--primary);">0</b></div>
                <div style="flex:1; background:white; padding:15px; border-radius:15px;">ì—°ì†: <b id="stat-days" style="color:var(--primary);">0</b>ì¼</div>
            </div>
            <div id="history-list"></div>
        </div>
    </div>

    <script>
        // 1. ì—¬ê¸°ì— í‚¤ë¥¼ ì •í™•íˆ ë„£ì–´ì£¼ì„¸ìš”!
        const API_KEY = "AIzaSyD4t-Mn7mUBBEk0c3m0n-yZHWN9zo0IB-c"; 

        let currentIndex = 0;
        let dialogue = []; 
        let scenarioInfo = "";
        let wordsInfo = "";
        let stats = JSON.parse(localStorage.getItem('jiyoungStats')) || { total: 0, days: 0, lastDate: '', history: [] };

        async function fetchDialogue() {
            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`;
                
                // AIì—ê²Œ í˜•ì‹ íŒŒê´´ë¥¼ ê¸ˆì§€í•˜ëŠ” ì•„ì£¼ êµ¬ì²´ì ì¸ ëª…ë ¹
                const prompt = "You are a travel English teacher. Generate a 6-line dialogue. " +
                               "Context: Random (Airport, Hotel, Taxi, or Shopping). " +
                               "Characters: Staff and Jiyoung. " +
                               "Response MUST be ONLY a valid JSON object, no introduction or conclusion. " +
                               "JSON structure: { \"situation\": \"string\", \"lines\": [ { \"speaker\": \"Staff or Jiyoung\", \"en\": \"string\", \"ko\": \"í•œêµ­ì–´\", \"pr\": \"ë°œìŒ\" } ], \"words\": \"string\" }";

                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const json = await res.json();
                
                // AI ì‘ë‹µ í…ìŠ¤íŠ¸ ì •ì œ (ë¶ˆí•„ìš”í•œ ```json ë§ˆí¬ë‹¤ìš´ ì œê±°)
                let rawText = json.candidates[0].content.parts[0].text;
                rawText = rawText.replace(/```json/g, "").replace(/```/g, "").trim();
                
                const data = JSON.parse(rawText);
                dialogue = data.lines;
                scenarioInfo = data.situation;
                wordsInfo = data.words;

                document.getElementById('loading-overlay').style.display = 'none';
                renderStep();
            } catch (e) {
                console.error("ì—ëŸ¬ ë°œìƒ:", e);
                document.getElementById('loading-text').innerText = "ì—°ê²° ì˜¤ë¥˜! 7ì´ˆ í›„ ë¹„ìƒ ëŒ€ë³¸ìœ¼ë¡œ ì‹œì‘í•©ë‹ˆë‹¤...";
                setTimeout(useFallback, 3000);
            }
        }

        function useFallback() {
            scenarioInfo = "ë¹„ìƒìš© ìƒí™©: í˜¸í…” ì¡°ì‹ ë¬¸ì˜";
            dialogue = [
                {speaker:'Jiyoung', en:'What time is breakfast?', ko:'ì¡°ì‹ ì‹œê°„ì´ ì–¸ì œì¸ê°€ìš”?', pr:'ì™“ íƒ€ì„ ì´ì¦ˆ ë¸Œë ‰í¼ìŠ¤íŠ¸?'},
                {speaker:'Staff', en:'It is from 7 to 10 AM.', ko:'ì˜¤ì „ 7ì‹œë¶€í„° 10ì‹œê¹Œì§€ì…ë‹ˆë‹¤.', pr:'ì‡ ì´ì¦ˆ í”„ë¡¬ ì„¸ë¸ íˆ¬ í… ì—ì´ì— .'},
                {speaker:'Jiyoung', en:'Where is the restaurant?', ko:'ì‹ë‹¹ì€ ì–´ë””ì— ìˆë‚˜ìš”?', pr:'ì›¨ì–´ ì´ì¦ˆ ë” ë ˆìŠ¤í† ë‘?'},
                {speaker:'Staff', en:'It is on the second floor.', ko:'2ì¸µì— ìˆìŠµë‹ˆë‹¤.', pr:'ì‡ ì´ì¦ˆ ì˜¨ ë” ì„¸ì»¨ë“œ í”Œë¡œì–´.'},
                {speaker:'Jiyoung', en:'Thank you for the information.', ko:'ì •ë³´ ê°ì‚¬í•©ë‹ˆë‹¤.', pr:'ë•¡í í¬ ë” ì¸í¬ë©”ì´ì…˜.'},
                {speaker:'Staff', en:'You are welcome. Enjoy!', ko:'ì²œë§Œì—ìš”. ì¦ê±°ìš´ ì‹œê°„ ë˜ì„¸ìš”!', pr:'ìœ  ì•„ ì›°ì»´. ì—”ì¡°ì´!'}
            ];
            document.getElementById('loading-overlay').style.display = 'none';
            renderStep();
        }

        function renderStep() {
            const line = dialogue[currentIndex];
            const card = document.getElementById('speaker-card');
            document.getElementById('lbl-situation').innerText = "ğŸ“ ìƒí™©: " + scenarioInfo;
            card.setAttribute('data-speaker', line.speaker === 'Jiyoung' ? "ì§€ì˜" : "ì§ì›");
            if(line.speaker === 'Jiyoung') card.classList.add('user-card'); else card.classList.remove('user-card');
            document.getElementById('lbl-meaning').innerText = line.ko;
            document.getElementById('lbl-english').innerText = line.en;
            document.getElementById('lbl-pronunciation').innerText = line.pr;
            document.getElementById('btn-prev').disabled = (currentIndex === 0);
            document.getElementById('btn-next').innerText = (currentIndex === dialogue.length - 1) ? "ì™„ë£Œ ğŸ’®" : "ë‹¤ìŒ â¡ï¸";
        }

        function nextStep() {
            if (currentIndex < dialogue.length - 1) { currentIndex++; renderStep(); }
            else { finishStudy(); }
        }

        function prevStep() { if (currentIndex > 0) { currentIndex--; renderStep(); } }

        function finishStudy() {
            document.getElementById('speaker-card').style.display = 'none';
            document.getElementById('main-btns').style.display = 'none';
            document.getElementById('btn-restart').style.display = 'block';
            saveStats();
        }

        function saveStats() {
            const today = new Date().toLocaleDateString();
            stats.total++;
            if (stats.lastDate !== today) { stats.days++; stats.lastDate = today; }
            localStorage.setItem('jiyoungStats', JSON.stringify(stats));
        }

        function switchPage(p) {
            document.querySelectorAll('.page').forEach(pg => pg.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(p + '-page').classList.add('active');
            document.getElementById('tab-' + p).classList.add('active');
            if(p === 'stats') {
                document.getElementById('stat-total').innerText = stats.total;
                document.getElementById('stat-days').innerText = stats.days;
            }
        }

        function playCurrentTTS() {
            window.speechSynthesis.cancel();
            const ut = new SpeechSynthesisUtterance(dialogue[currentIndex].en);
            ut.lang = 'en-US'; window.speechSynthesis.speak(ut);
        }

        fetchDialogue();
    </script>
</body>
</html>
