<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì§€ì˜ì´ì˜ ì˜ì–´ê³µë¶€</title>
    <style>
        :root { --primary: #ff4757; --secondary: #007aff; --bg: #fff9f9; }
        body { font-family: 'Apple SD Gothic Neo', sans-serif; text-align: center; padding: 0; margin: 0; background-color: var(--bg); color: #333; }
        
        .nav-tabs { display: flex; background: white; border-bottom: 1px solid #eee; position: sticky; top: 0; z-index: 100; }
        .tab { flex: 1; padding: 15px; font-size: 18px; font-weight: bold; cursor: pointer; color: #888; }
        .tab.active { color: var(--primary); border-bottom: 3px solid var(--primary); }

        .container { max-width: 500px; margin: 20px auto; padding: 0 20px; box-sizing: border-box; }
        .page { display: none; }
        .page.active { display: block; }

        .card { background: white; padding: 25px; border-radius: 25px; box-shadow: 0 8px 15px rgba(0,0,0,0.05); border: 1.5px solid #ffccd5; margin-bottom: 20px; min-height: 200px; display: flex; flex-direction: column; justify-content: center; }
        
        .meaning { font-size: 22px; color: #444; font-weight: bold; }
        .english { font-size: 26px; font-weight: bold; color: var(--secondary); margin: 12px 0; line-height: 1.3; }
        .pronunciation { font-size: 18px; color: #888; margin-bottom: 15px; }
        
        /* ë‹¨ì–´ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .word-box { text-align: left; background: #f1f2f6; padding: 20px; border-radius: 15px; margin-bottom: 20px; font-size: 17px; line-height: 1.6; border-left: 5px solid #ced4da; }
        .word-title { font-weight: bold; color: #555; margin-bottom: 8px; display: block; border-bottom: 1px solid #ddd; padding-bottom: 5px; }

        .btn-group { display: flex; gap: 10px; margin: 15px 0; }
        .nav-btn { flex: 1; padding: 15px; border-radius: 12px; border: 1px solid #ddd; background: white; cursor: pointer; font-size: 16px; }
        .speak-btn { background: var(--primary); color: white; border: none; padding: 20px; font-size: 20px; border-radius: 15px; width: 100%; cursor: pointer; font-weight: bold; box-shadow: 0 4px 0 #e03a49; }
        .tts-btn { background: #e1f5fe; color: #0288d1; border: none; padding: 10px 20px; border-radius: 50px; cursor: pointer; font-size: 18px; font-weight: bold; margin-bottom: 10px; }
        
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stat-item { background: white; padding: 20px; border-radius: 20px; border: 1px solid #eee; }
        .stat-val { font-size: 30px; font-weight: bold; color: var(--primary); display: block; }
        .history-list { text-align: left; margin-top: 10px; background: white; border-radius: 15px; padding: 10px; }
        .history-item { padding: 10px; border-bottom: 1px solid #f9f9f9; font-size: 16px; }
    </style>
</head>
<body>

    <div class="nav-tabs">
        <div class="tab active" id="tab-study" onclick="switchPage('study')">ğŸ“– ê³µë¶€í•˜ê¸°</div>
        <div class="tab" id="tab-stats" onclick="switchPage('stats')">ğŸ“Š ê³µë¶€ê¸°ë¡</div>
    </div>

    <div class="container">
        <div id="study-page" class="page active">
            <div class="card">
                <p id="loading-msg">ì§€ì˜ ë‹˜ì„ ìœ„í•œ ë§ì¶¤ ë¬¸ì¥ì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤...</p>
                <div id="content-area" style="display:none;">
                    <p class="meaning" id="lbl-meaning"></p>
                    <p class="english" id="lbl-english"></p>
                    <p class="pronunciation" id="lbl-pronunciation"></p>
                    <button class="tts-btn" onclick="playTTS()">ğŸ”Š ì›ì–´ë¯¼ ë°œìŒ ë“£ê¸°</button>
                </div>
            </div>

            <div id="word-area" class="word-box" style="display:none;">
                <span class="word-title">ğŸ’¡ ì£¼ìš” ë‹¨ì–´ ìµíˆê¸°</span>
                <div id="lbl-words"></div>
            </div>

            <div class="btn-group">
                <button class="nav-btn" onclick="prevStep()">â¬…ï¸ ì´ì „</button>
                <button class="nav-btn" onclick="nextStep()">ë‹¤ìŒ â¡ï¸</button>
            </div>
            <button class="speak-btn" onclick="startRecognition()">ğŸ¤ ë‚´ ë°œìŒ í™•ì¸í•˜ê¸°</button>
            <div id="feedback" style="margin-top:20px; font-size:18px; color:#555; line-height:1.5;"></div>
        </div>

        <div id="stats-page" class="page">
            <div class="stat-grid">
                <div class="stat-item">
                    <span class="stat-val" id="stat-total">0</span>
                    <span style="font-size:14px; color:#666;">ëˆ„ì  í•™ìŠµ ë¬¸ì¥</span>
                </div>
                <div class="stat-item">
                    <span class="stat-val" id="stat-days">0</span>
                    <span style="font-size:14px; color:#666;">ì—°ì† í•™ìŠµì¼</span>
                </div>
            </div>
            <h3 style="text-align:left; margin: 25px 0 10px 10px;">ìµœê·¼ ê³µë¶€í•œ ë¬¸ì¥ë“¤</h3>
            <div id="history-list" class="history-list"></div>
        </div>
    </div>

    <script>
        const API_KEY = "AIzaSyD4t-Mn7mUBBEk0c3m0n-yZHWN9zo0IB-c"; 
        let currentIndex = 0;
        let dailyData = [];
        let stats = JSON.parse(localStorage.getItem('jiyoungStats')) || { total: 0, days: 0, lastDate: '', history: [] };

        const fallbackData = [
            { en: "Could you recommend a good local restaurant?", ko: "ê·¼ì²˜ì— ë§›ìˆëŠ” ì‹ë‹¹ ì¢€ ì¶”ì²œí•´ ì£¼ì‹œê² ì–´ìš”?", pr: "ì¿ ë“œ ìœ  ë ˆì½”ë©˜ë“œ ì–´ êµ¿ ë¡œì»¬ ë ˆìŠ¤í† ë‘?", words: "<b>Recommend:</b> ì¶”ì²œí•˜ë‹¤<br><b>Local:</b> í˜„ì§€ì˜" },
            { en: "I'd like to check in, please.", ko: "ì²´í¬ì¸ì„ í•˜ê³  ì‹¶ìŠµë‹ˆë‹¤.", pr: "ì•„ì´ë“œ ë¼ì´í¬ íˆ¬ ì²´í¬ì¸, í”Œë¦¬ì¦ˆ.", words: "<b>Check in:</b> íˆ¬ìˆ™ ìˆ˜ì†ì„ í•˜ë‹¤" }
        ];

        async function fetchDailySentences() {
            const timer = setTimeout(() => { if(dailyData.length===0) useFallback(); }, 5000);
            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`;
                // ë‚œì´ë„ ì¡°ì ˆ í”„ë¡¬í”„íŠ¸: ì¤‘ê¸‰ ì—¬í–‰ ì˜ì–´
                const prompt = "Generate 5 intermediate travel English sentences for a Korean learner in JSON format. Fields: en, ko, pr, words(detailed explanation in Korean). Provide ONLY a JSON array.";
                const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                const json = await res.json();
                let text = json.candidates[0].content.parts[0].text;
                dailyData = JSON.parse(text.replace(/```json|```/g, ""));
                clearTimeout(timer);
                showContent();
            } catch (e) { useFallback(); }
        }

        function useFallback() { dailyData = fallbackData; showContent(); }
        function showContent() {
            document.getElementById('loading-msg').style.display = 'none';
            document.getElementById('content-area').style.display = 'block';
            document.getElementById('word-area').style.display = 'block';
            updateUI();
        }

        function updateUI() {
            const item = dailyData[currentIndex];
            document.getElementById('lbl-meaning').innerText = item.ko;
            document.getElementById('lbl-english').innerText = item.en;
            document.getElementById('lbl-pronunciation').innerText = item.pr;
            document.getElementById('lbl-words').innerHTML = item.words;
            updateStatsUI();
        }

        function playTTS() {
            window.speechSynthesis.cancel();
            const ut = new SpeechSynthesisUtterance(dailyData[currentIndex].en);
            const voices = window.speechSynthesis.getVoices();
            // ì„ ëª…í•œ ëª©ì†Œë¦¬ ìš°ì„ ìˆœìœ„
            const v = voices.find(v => v.name.includes('Google') || v.name.includes('Samantha')) || voices[0];
            ut.voice = v; ut.pitch = 1.15; ut.rate = 0.8; ut.lang = 'en-US';
            window.speechSynthesis.speak(ut);
        }

        function switchPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(pageId + '-page').classList.add('active');
            document.getElementById('tab-' + pageId).classList.add('active');
            if(pageId === 'stats') updateStatsUI();
        }

        function updateStatsUI() {
            document.getElementById('stat-total').innerText = stats.total;
            document.getElementById('stat-days').innerText = stats.days;
            const list = document.getElementById('history-list');
            list.innerHTML = stats.history.length ? stats.history.slice(-5).reverse().map(h => `<div class="history-item">ğŸ’® ${h}</div>`).join('') : "ê³µë¶€ ê¸°ë¡ì´ ì—¬ê¸°ì— ë‚˜íƒ€ë‚©ë‹ˆë‹¤!";
        }

        async function startRecognition() {
            const rec = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            rec.lang = 'en-US';
            document.getElementById('feedback').innerText = "ì§€ì˜ ë‹˜, ë§ì”€í•´ ë³´ì„¸ìš”! ê·€ ê¸°ìš¸ì´ê³  ìˆì–´ìš”.";
            rec.start();
            rec.onresult = async (e) => {
                const speech = e.results[0][0].transcript;
                document.getElementById('feedback').innerText = "ë¶„ì„ ì¤‘...";
                const fb = await getGeminiFeedback(speech, dailyData[currentIndex].en);
                document.getElementById('feedback').innerText = fb;
                saveRecord(dailyData[currentIndex].en);
            };
        }

        function saveRecord(sentence) {
            const today = new Date().toLocaleDateString();
            if (!stats.history.includes(sentence)) {
                stats.total++;
                stats.history.push(sentence);
                if (stats.lastDate !== today) {
                    stats.days++;
                    stats.lastDate = today;
                }
                localStorage.setItem('jiyoungStats', JSON.stringify(stats));
            }
        }

        async function getGeminiFeedback(s, t) {
            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`;
                const prompt = `ì§€ì˜ ë‹˜ ë°œìŒ: "${s}", ëª©í‘œ: "${t}". ë‹¤ì •í•˜ê²Œ ì¹­ì°¬ í•œì¤„ê³¼ "ì°¸ ì˜í•˜ì…¨ì–´ìš”! ğŸ’®"ë¼ê³  í•´ì¤˜.`;
                const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                const json = await res.json();
                return json.candidates[0].content.parts[0].text;
            } catch(e) { return "ì§€ì˜ ë‹˜, ì •ë§ í›Œë¥­í•´ìš”! ì°¸ ì˜í•˜ì…¨ì–´ìš”! ğŸ’®"; }
        }

        function nextStep() { if (currentIndex < dailyData.length - 1) { currentIndex++; updateUI(); } }
        function prevStep() { if (currentIndex > 0) { currentIndex--; updateUI(); } }

        window.speechSynthesis.onvoiceschanged = () => {};
        fetchDailySentences();
    </script>
</body>
</html>
