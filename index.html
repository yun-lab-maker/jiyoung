<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì§€ì˜ì´ì˜ ì˜ì–´ ê³µë¶€</title>
    <style>
        :root { --primary: #ff4757; --secondary: #007aff; --bg: #fff9f9; }
        body { font-family: 'Apple SD Gothic Neo', sans-serif; text-align: center; padding: 0; margin: 0; background-color: var(--bg); color: #333; }
        .nav-tabs { display: flex; background: white; border-bottom: 1px solid #eee; position: sticky; top: 0; z-index: 100; }
        .tab { flex: 1; padding: 15px; font-size: 18px; font-weight: bold; cursor: pointer; color: #888; }
        .tab.active { color: var(--primary); border-bottom: 3px solid var(--primary); }
        .container { max-width: 500px; margin: 20px auto; padding: 0 20px; box-sizing: border-box; }
        .page { display: none; }
        .page.active { display: block; }
        .situation-tag { background: #ffeaa7; color: #d63031; padding: 5px 15px; border-radius: 50px; font-weight: bold; font-size: 14px; margin-bottom: 15px; display: inline-block; }
        .card { background: white; padding: 35px 20px; border-radius: 25px; box-shadow: 0 8px 15px rgba(0,0,0,0.05); border: 2px solid #ffccd5; margin-bottom: 15px; position: relative; min-height: 180px; display: flex; flex-direction: column; justify-content: center; }
        .card::before { content: attr(data-speaker); position: absolute; top: -15px; left: 20px; background: #555; color: white; padding: 4px 15px; border-radius: 10px; font-size: 14px; font-weight: bold; }
        .card.user-card { border-color: var(--secondary); background: #f0f7ff; }
        .card.user-card::before { background: var(--secondary); }
        .meaning { font-size: 22px; color: #444; font-weight: bold; margin-bottom: 10px; }
        .english { font-size: 26px; font-weight: bold; color: var(--secondary); margin: 10px 0; line-height: 1.3; }
        .pronunciation { font-size: 18px; color: #888; margin-bottom: 15px; }
        .full-script { background: white; padding: 25px; border-radius: 25px; border: 2px solid #ddd; text-align: left; margin-top: 20px; display: none; }
        .script-line { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #f0f0f0; }
        .word-box { text-align: left; background: #f1f2f6; padding: 20px; border-radius: 15px; margin-top: 20px; font-size: 17px; border-left: 5px solid #ced4da; display: none; }
        .btn-group { display: flex; gap: 10px; margin: 20px 0; }
        .nav-btn { flex: 1; padding: 18px; border-radius: 15px; border: none; background: var(--primary); color: white; cursor: pointer; font-size: 18px; font-weight: bold; box-shadow: 0 5px 0 #e03a49; }
        .nav-btn.prev { background: #bbb; box-shadow: 0 5px 0 #999; }
        .tts-btn { background: #e1f5fe; color: #0288d1; border: none; padding: 10px 20px; border-radius: 50px; cursor: pointer; font-size: 16px; font-weight: bold; align-self: center; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stat-item { background: white; padding: 20px; border-radius: 20px; border: 1px solid #eee; }
        .stat-val { font-size: 30px; font-weight: bold; color: var(--primary); display: block; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; }
        .spinner { border: 5px solid #f3f3f3; border-top: 5px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .history-item { background: white; padding: 15px; border-radius: 15px; border: 1px solid #eee; margin-bottom: 10px; text-align: left; cursor: pointer; }
        #review-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 3000; overflow-y: auto; }
        .modal-content { background: white; width: 90%; max-width: 450px; margin: 50px auto; border-radius: 25px; padding: 25px; }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <div class="spinner"></div>
        <div style="font-weight: bold; color: #555;">ì§€ì˜ ë‹˜ì˜ ì˜¤ëŠ˜ì˜ ì£¼ì œë¥¼ ì •í•˜ê³  ìˆì–´ìš”...</div>
        <button onclick="useFallback()" style="margin-top:20px; border:none; background:none; text-decoration:underline; color:#999; cursor:pointer;">ë„ˆë¬´ ì˜¤ë˜ ê±¸ë¦¬ë©´ í´ë¦­í•˜ì„¸ìš”</button>
    </div>

    <div class="nav-tabs">
        <div class="tab active" id="tab-study" onclick="switchPage('study')">ğŸ“– ëŒ€í™” ì—°ìŠµ</div>
        <div class="tab" id="tab-stats" onclick="switchPage('stats')">ğŸ“Š ê³µë¶€ ê¸°ë¡</div>
    </div>
    
    <div class="container">
        <div id="study-page" class="page active">
            <div id="content-area">
                <div class="situation-tag" id="lbl-situation">ğŸ“ ìƒí™© ë¶„ì„ ì¤‘...</div>
                <div class="card" id="speaker-card" data-speaker="ì§€ì˜">
                    <p class="meaning" id="lbl-meaning"></p>
                    <p class="english" id="lbl-english"></p>
                    <p class="pronunciation" id="lbl-pronunciation"></p>
                    <button class="tts-btn" onclick="playCurrentTTS()">ğŸ”Š ì†Œë¦¬ ë“£ê¸°</button>
                </div>
                <div id="full-script-area" class="full-script">
                    <h3 style="margin-top:0; color:var(--primary);">ğŸ“œ ì „ì²´ ëŒ€ë³¸ ë³µìŠµ</h3>
                    <div id="script-content"></div>
                </div>
                <div id="word-area" class="word-box">
                    <span style="font-weight:bold; color:#555; display:block; margin-bottom:10px;">ğŸ’¡ ì£¼ìš” ë‹¨ì–´ ìµíˆê¸°</span>
                    <div id="lbl-words"></div>
                </div>
                <div class="btn-group" id="main-btns">
                    <button class="nav-btn prev" id="btn-prev" onclick="prevStep()">â¬…ï¸ ì´ì „</button>
                    <button class="nav-btn" id="btn-next" onclick="nextStep()">ë‹¤ìŒ â¡ï¸</button>
                </div>
                <button class="nav-btn" id="btn-restart" style="display:none; background:#555; box-shadow:0 5px 0 #333;" onclick="location.reload()">ìƒˆë¡œìš´ ìƒí™© ì‹œì‘</button>
            </div>
        </div>
        <div id="stats-page" class="page">
            <div class="stat-grid">
                <div class="stat-item"><span class="stat-val" id="stat-total">0</span><span style="font-size:14px; color:#666;">ì™„ë£Œí•œ ìƒí™©ê·¹</span></div>
                <div class="stat-item"><span class="stat-val" id="stat-days">0</span><span style="font-size:14px; color:#666;">ì—°ì† í•™ìŠµì¼</span></div>
            </div>
            <div style="text-align:left; margin-top:25px;"><h4 style="margin-left:5px;">ğŸ“… ìµœê·¼ í•™ìŠµ ë‚´ì—­</h4><div id="history-list"></div></div>
        </div>
    </div>

    <div id="review-modal" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 id="modal-title" style="color:var(--primary); margin-top:0;">ë³µìŠµí•˜ê¸°</h3>
            <div id="modal-body" style="margin-top:20px;"></div>
            <hr><div id="modal-words" class="word-box" style="display:block; background:#f9f9f9; border:none; margin-top:10px;"></div>
            <button class="nav-btn" style="margin-top:20px;" onclick="closeModal()">ë‹«ê¸°</button>
        </div>
    </div>
    
    <script>
        const API_KEY = "AIzaSyD4t-Mn7mUBBEk0c3m0n-yZHWN9zo0IB-c"; 
        let currentIndex = 0;
        let dialogue = []; 
        let scenarioInfo = "";
        let wordsInfo = "";
        let stats = JSON.parse(localStorage.getItem('jiyoungStats')) || { total: 0, days: 0, lastDate: '', history: [] };
        
        // 10ì´ˆ ì´ìƒ ê±¸ë¦¬ë©´ ê°•ì œë¡œ ê¸°ë³¸ ëŒ€ë³¸ ì‹¤í–‰
        const timeoutTrigger = setTimeout(() => { if(dialogue.length === 0) useFallback(); }, 12000);

        async function fetchDialogue() {
            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`;
                const prompt = "Randomly pick (Airport, Hotel, Taxi, Shop, Street). Generate 6-line English dialogue Staff vs Jiyoung. Return ONLY JSON: {situation, lines:[{speaker,en,ko,pr}], words}";
                const res = await fetch(url, { method: 'POST', body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                const json = await res.json();
                const rawText = json.candidates[0].content.parts[0].text.replace(/```json|```/g, "").trim();
                const data = JSON.parse(rawText);
                dialogue = data.lines; scenarioInfo = data.situation; wordsInfo = data.words;
                startApp();
            } catch (e) { console.error(e); useFallback(); }
        }

        function useFallback() {
            clearTimeout(timeoutTrigger);
            scenarioInfo = "ë¹„í–‰ê¸°ì—ì„œ ìŒë£Œ ì£¼ë¬¸í•˜ê¸°";
            dialogue = [
                {speaker:'Staff', en:'Would you like something to drink?', ko:'ìŒë£Œ ì¢€ ë“œë¦´ê¹Œìš”?', pr:'ìš°ì¥¬ ë¼ì´í¬ ì¸ëµ íˆ¬ ë“œë§í¬?'},
                {speaker:'Jiyoung', en:'What kind of juice do you have?', ko:'ì–´ë–¤ ì¢…ë¥˜ì˜ ì£¼ìŠ¤ê°€ ìˆë‚˜ìš”?', pr:'ì™“ ì¹´ì¸ë“œ ì˜¤ë¸Œ ì£¼ìŠ¤ ë‘ ìœ  í•´ë¸Œ?'},
                {speaker:'Staff', en:'We have orange, apple, and tomato juice.', ko:'ì˜¤ë Œì§€, ì‚¬ê³¼, í† ë§ˆí†  ì£¼ìŠ¤ê°€ ìˆìŠµë‹ˆë‹¤.', pr:'ìœ„ í•´ë¸Œ ì˜¤ë Œì§€, ì• í”Œ, ì•¤ í† ë§ˆí†  ì£¼ìŠ¤.'},
                {speaker:'Jiyoung', en:'Orange juice, please. No ice.', ko:'ì˜¤ë Œì§€ ì£¼ìŠ¤ ì£¼ì„¸ìš”. ì–¼ìŒì€ ë¹¼ê³ ìš”.', pr:'ì˜¤ë Œì§€ ì£¼ìŠ¤, í”Œë¦¬ì¦ˆ. ë…¸ ì•„ì´ìŠ¤.'},
                {speaker:'Staff', en:'Here you go. Enjoy your drink.', ko:'ì—¬ê¸° ìˆìŠµë‹ˆë‹¤. ë§›ìˆê²Œ ë“œì„¸ìš”.', pr:'íˆì–´ ìœ  ê³ . ì—”ì¡°ì´ ìœ ì–´ ë“œë§í¬.'},
                {speaker:'Jiyoung', en:'Thank you very much.', ko:'ì •ë§ ê°ì‚¬í•©ë‹ˆë‹¤.', pr:'ë•¡í ë² ë¦¬ ë¨¸ì¹˜.'}
            ];
            wordsInfo = "<b>Juice:</b> ì£¼ìŠ¤<br><b>No Ice:</b> ì–¼ìŒ ì—†ì´";
            startApp();
        }

        function startApp() {
            document.getElementById('loading-overlay').style.display = 'none';
            renderStep();
        }

        function renderStep() {
            const line = dialogue[currentIndex];
            const card = document.getElementById('speaker-card');
            document.getElementById('lbl-situation').innerText = "ğŸ“ ìƒí™©: " + scenarioInfo;
            card.setAttribute('data-speaker', line.speaker === 'Jiyoung' ? "ì§€ì˜" : "ì§ì› (Staff)");
            if(line.speaker === 'Jiyoung') card.classList.add('user-card'); else card.classList.remove('user-card');
            document.getElementById('lbl-meaning').innerText = line.ko;
            document.getElementById('lbl-english').innerText = line.en;
            document.getElementById('lbl-pronunciation').innerText = line.pr;
            document.getElementById('btn-prev').disabled = (currentIndex === 0);
            document.getElementById('btn-next').innerText = (currentIndex === dialogue.length - 1) ? "í•™ìŠµ ì™„ë£Œ ğŸ’®" : "ë‹¤ìŒ â¡ï¸";
        }

        function nextStep() {
            if (currentIndex < dialogue.length - 1) { currentIndex++; renderStep(); }
            else { finishStudy(); }
        }

        function prevStep() { if (currentIndex > 0) { currentIndex--; renderStep(); } }

        function finishStudy() {
            document.getElementById('speaker-card').style.display = 'none';
            document.getElementById('main-btns').style.display = 'none';
            document.getElementById('script-content').innerHTML = dialogue.map(l => `<div style="margin-bottom:10px;"><small>${l.speaker==='Jiyoung'?'ì§€ì˜':'ì§ì›'}</small><br><b>${l.en}</b><br>${l.ko}</div>`).join('');
            document.getElementById('full-script-area').style.display = 'block';
            document.getElementById('lbl-words').innerHTML = wordsInfo;
            document.getElementById('word-area').style.display = 'block';
            document.getElementById('btn-restart').style.display = 'block';
            saveStats();
        }

        function saveStats() {
            const today = new Date().toLocaleDateString();
            stats.total++;
            stats.history.push({ date: today, situation: scenarioInfo, lines: dialogue, words: wordsInfo });
            if (stats.lastDate !== today) { stats.days++; stats.lastDate = today; }
            localStorage.setItem('jiyoungStats', JSON.stringify(stats));
        }

        function switchPage(p) {
            document.querySelectorAll('.page').forEach(pg => pg.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(p + '-page').classList.add('active');
            document.getElementById('tab-' + p).classList.add('active');
            if(p === 'stats') renderHistory();
        }

        function renderHistory() {
            document.getElementById('stat-total').innerText = stats.total;
            document.getElementById('stat-days').innerText = stats.days;
            document.getElementById('history-list').innerHTML = stats.history.slice(-10).reverse().map((h, i) => `
                <div class="history-item" onclick="openReview(${stats.history.length-1-i})">
                    <small>${h.date}</small><br><strong>ğŸ’® ${h.situation}</strong>
                </div>`).join('');
        }

        function openReview(idx) {
            const data = stats.history[idx];
            document.getElementById('modal-title').innerText = data.situation;
            document.getElementById('modal-body').innerHTML = data.lines.map(l => `<div><b>${l.en}</b><br>${l.ko}</div><br>`).join('');
            document.getElementById('modal-words').innerHTML = data.words;
            document.getElementById('review-modal').style.display = 'block';
        }

        function closeModal() { document.getElementById('review-modal').style.display = 'none'; }
        
        function playCurrentTTS() {
            window.speechSynthesis.cancel();
            const ut = new SpeechSynthesisUtterance(dialogue[currentIndex].en);
            ut.lang = 'en-US'; window.speechSynthesis.speak(ut);
        }

        // í‚¤ê°€ ì…ë ¥ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸ í›„ ì‹¤í–‰
        if (API_KEY.includes("API_KEY")) {
            alert("API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì½”ë“œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”!");
            useFallback();
        } else {
            fetchDialogue();
        }
    </script>
</body>
</html>
